# 프로젝트 도메인 기반 서비스 구조 발표

## 1. 프로젝트 개요 및 도메인 기반 설계
-   **프로젝트명**: GTRPGM Rule Engine
-   **목표**: 테이블탑 RPG(TRPG) 게임의 핵심 로직 및 백엔드 서비스 제공
-   **설계 원칙**: 목적별 계층 분리 및 객체지향 설계
    -   각 도메인은 독립적인 비즈니스 로직과 데이터 관리를 책임
    -   유지보수성, 확장성, 모듈성 극대화

## 2. 도메인과 데이터베이스 연관성
-   **데이터 영속성**: 모든 도메인은 PostgreSQL 데이터베이스를 통해 데이터를 관리
-   **표준화된 접근**:
    -   `Service` 계층에서 `cursor` 객체를 통해 데이터베이스와 상호작용
    -   SQL 쿼리는 `src/domains/<domain>/queries/` 폴더 내 `.sql` 파일로 분리 관리
    -   `src/utils/load_sql.py` 유틸리티를 사용하여 쿼리를 로드, 서비스 코드의 가독성 및 재사용성 증대
    -   데이터 유효성 검증 및 모델링을 위해 Pydantic 기반의 DTO(Data Transfer Object) 사용 (`dtos/` 폴더)

## 3. 공통 개발 원칙 및 코드 구조 (모든 도메인)
-   **객체지향 설계 (OOP)**:
    -   `Router`와 `Service` 계층은 함수형이 아닌 클래스 선언을 원칙으로 구현
    -   각 기능은 클래스 내부 메서드로 구현하여 응집도 향상
-   **계층형 아키텍처**:
    -   **Router**: API 엔드포인트 정의, 요청 접수 및 응답 반환 (로직 최소화)
    -   **Service**: 핵심 비즈니스 로직, 유효성 검사, 데이터 가공 및 쿼리 실행
    -   **Repository (Queries)**: 데이터베이스와의 직접적인 상호작용 (SQL 파일)
-   **코드 품질**:
    -   Pythonic Code 준수, Ruff 린팅 및 포맷팅 적용
    -   모든 메서드의 인자와 반환 값에 Type Hinting 명시
-   **공통 유틸리티 활용**: `src/common/utils/` 및 `src/utils/`의 유틸리티 모듈 공유

## 4. GM (Game Master) 도메인: 주사위 판정 시스템
-   **목적**: TRPG 스타일의 주사위(2d6) 기반 성공/실패 판정 로직 제공
-   **핵심 기능**: 플레이어 능력치(`ability_val`)와 난이도(`diff`)를 활용하여 성공, 실패, 치명적 성공/실패 결과 도출
-   **기술 스택**: 순수 파이썬 로직 (`src/utils/dice_util.py` 활용), 데이터베이스 미사용 (현재 기능 기준)
-   **활용**: 게임 내 다양한 액션의 확률적 성공 여부 결정

## 5. Info 도메인: 게임 세계 정보 조회
-   **목적**: 게임 세계의 아이템, 몬스터, NPC, 세계관 등 다양한 정보를 제공하는 읽기 전용 API
-   **핵심 기능**:
    -   각 정보 유형별(`Enemy`, `Item`, `NPC`, `Personality`, `World`) 조회 서비스 분리
    -   페이지네이션 및 상세 정보 조회 기능 지원
-   **기술 스택**: PostgreSQL 데이터베이스 연동, `load_sql`을 통한 쿼리 관리
-   **활용**: 클라이언트(예: 프론트엔드) 및 다른 도메인 서비스에서 게임 데이터 조회

## 6. Scenario 도메인: 게임 엔티티 생성 및 관리
-   **목적**: 게임 시나리오의 핵심 엔티티(아이템, 몬스터, NPC 등)를 생성하고 관리하는 기능 제공
-   **핵심 기능**:
    -   아이템, 몬스터, NPC 등 게임 구성 요소를 데이터베이스에 추가 (`INSERT` 쿼리)
    -   데이터베이스 트랜잭션 관리(commit/rollback)를 통한 데이터 무결성 보장
-   **기술 스택**: PostgreSQL 데이터베이스 연동, `load_sql`을 통한 쿼리 관리
-   **활용**: 게임 초기 설정, 새로운 콘텐츠 추가 등 데이터 프로비저닝

## 7. Play 도메인 (1/3): LLM 기반 시나리오 엔진
-   **목적**: 게임 플레이의 핵심 로직 및 **LLM(Large Language Model) 통합**을 통한 동적 시나리오 처리
-   **핵심 컨셉**: `langgraph` 기반의 상태 머신을 활용하여 복잡한 게임 시나리오의 흐름 조율
-   **주요 구성 요소**:
    -   `PlayService`: `langgraph` 워크플로를 통해 시나리오 분석 및 페이즈(전투, 탐험, 대화 등) 로직 실행
    -   `LLMManager`: LLM 인스턴스 관리 및 `structured_output`을 통한 정형화된 응답 처리
-   **역할**: LLM을 통해 게임 상황을 분석하고 적절한 비즈니스 로직을 동적으로 실행

## 8. Play 도메인 (2/3): LangGraph 워크플로 상세
-   **워크플로 구조**: `PlaySessionState`를 기반으로 하는 `StateGraph` 정의
-   **동적 노드 처리**:
    -   `analyze_scene_node`, `fetch_world_data_node`, `categorize_entities_node` 등 일반 처리 노드
    -   `combat_node`, `exploration_node`, `dialogue_node` 등 다양한 게임 페이즈별 노드
-   **조건부 라우팅**: `analysis.phase_type` 값에 따라 각 페이즈 노드로 동적 라우팅
-   **시나리오 흐름**: `analyze_scene` -> `fetch_world_data` -> `categorize_entities` -> (조건부) 특정 페이즈 노드

## 9. Play 도메인 (3/3): LLM 기반 미니게임 시스템
-   **목적**: LLM을 활용한 동적 미니게임(수수께끼, 퀴즈) 생성 및 사용자 답변 검증
-   **핵심 기능**:
    -   `MinigameService`: LLM(`examiner`, `evaluator`)을 사용하여 문제/답변 동적 생성 및 검증
    -   Redis를 통해 미니게임의 실시간 상태(정답, 힌트, 오답 횟수, TTL) 관리
    -   `Info` 도메인의 서비스를 활용하여 게임 세계 데이터 기반의 컨텍스트 풍부한 퀴즈 생성
-   **프롬프트 관리**: `prompts/` 디렉토리의 시스템 프롬프트 및 동적 프롬프트 생성 함수 활용
-   **활용**: 사용자 참여 유도 및 게임 내 다양한 인터랙션 제공

## 10. Session 도메인: 사용자 세션 관리
-   **목적**: 사용자 세션의 생성, 조회, 논리적 삭제 및 상태 관리
-   **핵심 기능**:
    -   사용자별 세션 목록 페이지네이션 조회 (활성/삭제 세션 필터링)
    -   새로운 사용자 세션 추가
    -   기존 세션을 논리적으로 삭제(is_deleted 플래그 업데이트)
-   **기술 스택**: PostgreSQL 데이터베이스 연동, `load_sql`을 통한 쿼리 관리, `PaginationMeta`를 통한 페이지네이션 지원

## 11. User 도메인: 사용자 계정 관리
-   **목적**: 사용자 계정(회원)의 CRUD(생성, 조회, 수정, 삭제) 작업 관리
-   **핵심 기능**:
    -   회원 가입, 회원 정보 조회, 회원 정보 수정, 비밀번호 변경
    -   회원 탈퇴(논리적 삭제)
-   **기술 스택**: PostgreSQL 데이터베이스 연동, `load_sql`을 통한 쿼리 관리, Pydantic DTO를 통한 요청/응답 구조화

## 12. 결론 및 향후 계획
-   **결론**: 도메인 기반 설계와 LLM 통합을 통해 유연하고 확장 가능한 TRPG Rule Engine 구축
-   **강점**:
    -   명확한 책임 분리로 높은 모듈성과 유지보수성 확보
    -   LLM 기반의 동적 콘텐츠 생성 및 시나리오 처리 능력
    -   재사용 가능한 공통 유틸리티 및 엄격한 코드 품질 관리
-   **향후 계획**: 지속적인 LLM 모델 개선, 새로운 도메인 및 기능 추가를 통한 서비스 확장
